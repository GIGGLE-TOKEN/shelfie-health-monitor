<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Shelfie System Health Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .status-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            padding: 30px; 
        }
        .status-card { 
            background: #f8f9fa; 
            border-radius: 8px; 
            padding: 20px; 
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }
        .status-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .status-card.healthy { border-left-color: #28a745; }
        .status-card.warning { border-left-color: #ffc107; }
        .status-card.error { border-left-color: #dc3545; }
        .status-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .status-title { font-weight: 600; font-size: 1.2em; color: #333; }
        .status-indicator { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            animation: pulse 2s infinite;
        }
        .status-indicator.healthy { background: #28a745; }
        .status-indicator.warning { background: #ffc107; }
        .status-indicator.error { background: #dc3545; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .status-message { color: #666; margin-bottom: 10px; }
        .status-latency { font-size: 0.9em; color: #999; }
        .refresh-btn { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            background: #667eea; 
            color: white; 
            border: none; 
            padding: 15px 25px; 
            border-radius: 50px; 
            cursor: pointer; 
            font-size: 1em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .refresh-btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .loading { text-align: center; padding: 50px; color: #666; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .success { color: #28a745; }
        .last-updated { 
            text-align: center; 
            padding: 20px; 
            color: #666; 
            font-size: 0.9em; 
            border-top: 1px solid #eee; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Shelfie System Health</h1>
            <p>Real-time monitoring of all system connections</p>
        </div>
        <div id="status-grid" class="status-grid">
            <div class="loading">Loading system status...</div>
        </div>
        <div class="last-updated" id="last-updated">
            Last updated: Loading...
        </div>
    </div>
    
    <button class="refresh-btn" onclick="refreshStatus()">üîÑ Refresh</button>
    
    <script>
        // Configuration
        const CONFIG = {
            apiBaseUrl: 'https://api.shelfieplatform.com',
            healthEndpoint: '/api/health',
            refreshInterval: 30000, // 30 seconds
            timeout: 10000 // 10 seconds
        };

        // Health check functions
        const healthChecks = {
            async checkAPI() {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${CONFIG.apiBaseUrl}/api/health`, {
                        method: 'GET',
                        timeout: CONFIG.timeout
                    });
                    const latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        return { 
                            status: 'connected', 
                            message: `API server responding (${data.service})`, 
                            latency: latency 
                        };
                    } else {
                        return { 
                            status: 'error', 
                            message: `API Error: ${response.status}`, 
                            latency: null 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'error', 
                        message: `API Error: ${error.message}`, 
                        latency: null 
                    };
                }
            },

            async checkCloudFlare() {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${CONFIG.apiBaseUrl}${CONFIG.healthEndpoint}`, {
                        method: 'GET',
                        timeout: CONFIG.timeout
                    });
                    const latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        return { 
                            status: 'connected', 
                            message: 'CloudFlare CDN working', 
                            latency: latency 
                        };
                    } else {
                        return { 
                            status: 'error', 
                            message: `CloudFlare Error: ${response.status}`, 
                            latency: null 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'error', 
                        message: `CloudFlare Error: ${error.message}`, 
                        latency: null 
                    };
                }
            },

            async checkWebsite() {
                try {
                    const startTime = Date.now();
                    const response = await fetch('https://shelfieplatform.com', {
                        method: 'GET',
                        timeout: CONFIG.timeout
                    });
                    const latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        return { 
                            status: 'connected', 
                            message: 'Website accessible', 
                            latency: latency 
                        };
                    } else {
                        return { 
                            status: 'error', 
                            message: `Website Error: ${response.status}`, 
                            latency: null 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'error', 
                        message: `Website Error: ${error.message}`, 
                        latency: null 
                    };
                }
            },

            async checkBackend() {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${CONFIG.apiBaseUrl}/api/health`, {
                        method: 'GET',
                        timeout: CONFIG.timeout
                    });
                    const latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        return { 
                            status: 'connected', 
                            message: `Backend: ${data.service} system running`, 
                            latency: latency 
                        };
                    } else {
                        return { 
                            status: 'error', 
                            message: `Backend Error: ${response.status}`, 
                            latency: null 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'error', 
                        message: `Backend Error: ${error.message}`, 
                        latency: null 
                    };
                }
            },

            async checkAWSSES() {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${CONFIG.apiBaseUrl}/api/analytics/email/metrics`, {
                        method: 'GET',
                        timeout: CONFIG.timeout
                    });
                    const latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        return { 
                            status: 'connected', 
                            message: 'AWS SES email service configured', 
                            latency: latency 
                        };
                    } else {
                        return { 
                            status: 'warning', 
                            message: `AWS SES: ${response.status}`, 
                            latency: null 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'error', 
                        message: `AWS SES Error: ${error.message}`, 
                        latency: null 
                    };
                }
            },

            async checkMongoDB() {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${CONFIG.apiBaseUrl}/api/health`, {
                        method: 'GET',
                        timeout: CONFIG.timeout
                    });
                    const latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        return { 
                            status: 'connected', 
                            message: 'MongoDB Atlas connected via backend', 
                            latency: latency 
                        };
                    } else {
                        return { 
                            status: 'error', 
                            message: `MongoDB Error: ${response.status}`, 
                            latency: null 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'error', 
                        message: `MongoDB Error: ${error.message}`, 
                        latency: null 
                    };
                }
            },

            async checkEmailAnalytics() {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${CONFIG.apiBaseUrl}/api/analytics/email`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            event: 'health_check',
                            email: 'health@monitor.com',
                            data: { source: 'health_monitor' }
                        }),
                        timeout: CONFIG.timeout
                    });
                    const latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        return { 
                            status: 'connected', 
                            message: 'Email analytics tracking working', 
                            latency: latency 
                        };
                    } else {
                        return { 
                            status: 'warning', 
                            message: `Email Analytics: ${response.status}`, 
                            latency: null 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'error', 
                        message: `Email Analytics Error: ${error.message}`, 
                        latency: null 
                    };
                }
            },

            async checkEmailAlerting() {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${CONFIG.apiBaseUrl}/api/analytics/email/metrics`, {
                        method: 'GET',
                        timeout: CONFIG.timeout
                    });
                    const latency = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        const summary = data.data?.summary;
                        
                        if (summary) {
                            // Check for alert conditions
                            const bounceRate = summary.bounceRate || 0;
                            const openRate = summary.openRate || 0;
                            
                            let status = 'connected';
                            let message = 'Email alerting system working';
                            
                            if (bounceRate > 5) {
                                status = 'warning';
                                message = `High bounce rate: ${bounceRate.toFixed(2)}%`;
                            } else if (openRate < 10) {
                                status = 'warning';
                                message = `Low open rate: ${openRate.toFixed(2)}%`;
                            } else {
                                message += ` (Bounce: ${bounceRate.toFixed(2)}%, Open: ${openRate.toFixed(2)}%)`;
                            }
                            
                            return { 
                                status, 
                                message, 
                                latency: latency 
                            };
                        } else {
                            return { 
                                status: 'connected', 
                                message: 'Email alerting system ready', 
                                latency: latency 
                            };
                        }
                    } else {
                        return { 
                            status: 'warning', 
                            message: `Email Alerting: ${response.status}`, 
                            latency: null 
                        };
                    }
                } catch (error) {
                    return { 
                        status: 'error', 
                        message: `Email Alerting Error: ${error.message}`, 
                        latency: null 
                    };
                }
            }
        };

        // Main health check function
        async function performHealthCheck() {
            const startTime = Date.now();
            
            const results = {
                timestamp: new Date().toISOString(),
                overallStatus: 'unknown',
                services: {},
                checkDuration: 0
            };
            
            // Check all services
            results.services.api = await healthChecks.checkAPI();
            results.services.backend = await healthChecks.checkBackend();
            results.services.cloudflare = await healthChecks.checkCloudFlare();
            results.services.website = await healthChecks.checkWebsite();
            results.services.awsSES = await healthChecks.checkAWSSES();
            results.services.mongodb = await healthChecks.checkMongoDB();
            results.services.emailAnalytics = await healthChecks.checkEmailAnalytics();
            results.services.emailAlerting = await healthChecks.checkEmailAlerting();
            
            // Determine overall status
            const serviceStatuses = Object.values(results.services);
            const hasErrors = serviceStatuses.some(service => service.status === 'error');
            const hasWarnings = serviceStatuses.some(service => service.status === 'warning');
            
            if (hasErrors) {
                results.overallStatus = 'error';
            } else if (hasWarnings) {
                results.overallStatus = 'warning';
            } else {
                results.overallStatus = 'healthy';
            }
            
            results.checkDuration = Date.now() - startTime;
            
            return results;
        }

        // Display functions
        async function loadStatus() {
            try {
                const data = await performHealthCheck();
                displayStatus(data);
                updateLastUpdated(data.timestamp);
            } catch (error) {
                document.getElementById('status-grid').innerHTML = 
                    '<div class="error">Failed to load system status: ' + error.message + '</div>';
            }
        }
        
        function displayStatus(data) {
            const grid = document.getElementById('status-grid');
            let html = '';
            
            // Overall status
            html += `
                <div class="status-card ${data.overallStatus}">
                    <div class="status-header">
                        <div class="status-title">Overall System Status</div>
                        <div class="status-indicator ${data.overallStatus}"></div>
                    </div>
                    <div class="status-message">
                        System is ${data.overallStatus === 'healthy' ? 'operating normally' : 
                          data.overallStatus === 'warning' ? 'experiencing minor issues' : 'experiencing problems'}
                    </div>
                    <div class="status-latency">Check completed in ${data.checkDuration}ms</div>
                </div>
            `;
            
            // Individual services
            Object.entries(data.services).forEach(([name, service]) => {
                html += createStatusCard(name, service);
            });
            
            grid.innerHTML = html;
        }
        
        function createStatusCard(title, service) {
            const statusClass = service.status === 'connected' ? 'healthy' : 
                              service.status === 'warning' ? 'warning' : 'error';
            
            return `
                <div class="status-card ${statusClass}">
                    <div class="status-header">
                        <div class="status-title">${title.toUpperCase()}</div>
                        <div class="status-indicator ${statusClass}"></div>
                    </div>
                    <div class="status-message">${service.message}</div>
                    <div class="status-latency">
                        ${service.latency ? 'Response time: ' + service.latency + 'ms' : 'No response time data'}
                    </div>
                </div>
            `;
        }

        function updateLastUpdated(timestamp) {
            document.getElementById('last-updated').textContent = 
                'Last updated: ' + new Date(timestamp).toLocaleString();
        }
        
        function refreshStatus() {
            document.getElementById('status-grid').innerHTML = '<div class="loading">Refreshing system status...</div>';
            loadStatus();
        }
        
        // Load status on page load
        loadStatus();
        
        // Auto-refresh every 30 seconds
        setInterval(loadStatus, CONFIG.refreshInterval);
    </script>
</body>
</html>
